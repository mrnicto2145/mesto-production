(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const c={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"5345616d-4560-4d1b-870e-4d55f703c0f7","Content-Type":"application/json"}},a=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),j=()=>fetch(`${c.baseUrl}/users/me`,{headers:c.headers}).then(a),B=()=>fetch(`${c.baseUrl}/cards`,{headers:c.headers}).then(a),D=({name:e,about:t})=>fetch(`${c.baseUrl}/users/me`,{method:"PATCH",headers:c.headers,body:JSON.stringify({name:e,about:t})}).then(a),H=({avatar:e})=>(console.log(e),fetch(`${c.baseUrl}/users/me/avatar`,{method:"PATCH",headers:c.headers,body:JSON.stringify({avatar:e})}).then(a)),J=({name:e,link:t})=>fetch(`${c.baseUrl}/cards`,{method:"POST",headers:c.headers,body:JSON.stringify({name:e,link:t})}).then(a),R=e=>fetch(`${c.baseUrl}/cards/${e}`,{method:"DELETE",headers:c.headers}).then(a),Z=(e,t)=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:c.headers}).then(a),K=()=>fetch(`${c.baseUrl}/users`,{headers:c.headers}).then(a),M=(e,t,o,r)=>{e.classList.toggle("card__like-button_is-active"),Z(o._id,P(o.likes,r)).then(n=>{o.likes=n.likes,t.textContent=o.likes.length}).catch(n=>{console.log(n)})},A=(e,t)=>{e.remove(),R(t).then(o=>console.log(o.message)).catch(o=>{console.log(o)})},G=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0);function P(e,t){let o=!1;return e.forEach(r=>{o=o||r._id===t}),o}const U=(e,t,{onPreviewPicture:o,onLikeIcon:r,onDeleteCard:n})=>{const s=G(),l=s.querySelector(".card__like-button"),i=s.querySelector(".card__like-count"),p=s.querySelector(".card__control-button_type_delete"),u=s.querySelector(".card__image");return i.textContent=e.likes.length,u.src=e.link,u.alt=e.name,s.querySelector(".card__title").textContent=e.name,P(e.likes,t)&&l.classList.toggle("card__like-button_is-active"),r&&l.addEventListener("click",()=>r(l,i,e,t)),n&&p.addEventListener("click",()=>n(s,e._id)),o&&u.addEventListener("click",()=>o({name:e.name,link:e.link})),s},$=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");d(t)}},m=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",$)},d=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",$)},Q=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{d(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&d(e)})};function L(e,t,o,r){const n=e.querySelector(r.getErrorId(t));n.textContent=o,n.classList.add(r.errorClass)}function N(e,t,o){const r=e.querySelector(o.getErrorId(t));r.classList.remove(o.errorClass),r.textContent=""}function X(e,t,o,r){const n=o(t);N(e,t,r);let s=t.getAttribute(r.errorMessage);n!==0&&(n===1&&s!=null?L(e,t,t.getAttribute(r.errorMessage),r):L(e,t,t.validationMessage,r))}function Y(e,t){let o=Array.from(e.querySelectorAll(t.inputSelector));for(let r=0;r<o.length;r++)if(t.validators[r](o[r])!==0)return!0;return!1}function T(e,t){e.setAttribute("disabled",""),e.classList.add(t)}function ee(e,t){e.hasAttribute("disabled")&&e.removeAttribute("disabled"),e.classList.remove(t)}function te(e,t){const o=e.querySelector(t.submitButtonSelector);Y(e,t)?T(o,t.inactiveButtonClass):ee(o,t.inactiveButtonClass)}function v(e,t){let o=Array.from(e.querySelectorAll(t.inputSelector));for(let n=0;n<o.length;n++){let s={inputErrorClass:t.inputErrorClass[n],errorClass:t.errorClass[n],getErrorId:t.getErrorId};N(e,o[n],s)}let r=e.querySelector(t.submitButtonSelector);T(r,t.inactiveButtonClass)}function oe(e,t){let o=Array.from(e.querySelectorAll(t.inputSelector));for(let r=0;r<o.length;r++)o[r].addEventListener("input",n=>{X(e,o[r],t.validators[r],t),te(e,t)})}function re(e){const t=Array.from(document.querySelectorAll(e.formSelector));for(let o=0;o<e.formsCount;o++){let r={formSelector:e.formSelector,inputSelector:e.inputSelector,submitButtonSelector:e.submitButtonSelector,inactiveButtonClass:e.inactiveButtonClass,inputErrorClass:e.inputErrorClass,errorClass:e.errorClass,validators:e.validators[o],getErrorId:e.getErrorId,errorMessage:e.errorMessage};oe(t[o],r)}}function ne(e){return e.name!=="Jacques Cousteau"||e.about!=="Sailor, researcher"||e.avatar!=="https://pictures.s3.yandex.net/frontend-developer/common/ava.jpg"}const se=(e,t)=>{let o=[];return e.forEach(r=>{ne(r)&&o.push(r._id)}),t.forEach(r=>{r.likes.forEach(n=>{o.includes(n._id)||o.push(n._id)}),o.includes(r.owner._id)||o.push(r.owner._id)}),o},le=e=>{let t=0;return e.forEach(o=>t+=o.likes.length),t},ce=e=>{let t=new Map,o=new Map;e.forEach(s=>{s.likes.forEach(l=>{t.has(l._id)?t.set(l._id,t.get(l._id)+1):(t.set(l._id,0),o.set(l._id,l.name))})});let r,n=-1;for(let[s,l]of t)l>n&&(r=s,n=l);return{username:o.get(r),score:n}},ie=e=>{let t=new Map,o=new Map;e.forEach(n=>{t.set(n._id,n.likes.length),o.set(n._id,n.name)});let r=[["0",0],["0",0],["0",0]];for(let[n,s]of t)if(s>r[2][1]&&(r[2]=[n,s],r[2][1]>r[1][1])){let l=r[2];if(r[2]=r[1],r[1]=l,r[1][1]>r[0][1]){let i=r[1];r[1]=r[0],r[0]=i}}return[o.get(r[0][0]),o.get(r[1][0]),o.get(r[2][0])]},ae=()=>document.getElementById("popup-info-definition-template").content.querySelector(".popup__info-item").cloneNode(!0),ue=()=>document.getElementById("popup-info-user-preview-template").content.querySelector(".popup__list-item").cloneNode(!0),pe=(e,t,o,r,n)=>{e.querySelector(".popup__title").textContent=t;const s=e.querySelector(".popup__info");o.forEach(([i,p])=>{const u=ae();u.querySelector(".popup__info-term").textContent=i,u.querySelector(".popup__info-description").textContent=p,s.append(u)}),e.querySelector(".popup__text").textContent=r;const l=e.querySelector(".popup__list");n.forEach(i=>{const p=ue();p.textContent=i,l.append(p)})},de=e=>{e.querySelector(".popup__title").textContent="",e.querySelector(".popup__info").innerHTML="",e.querySelector(".popup__text").textContent="",e.querySelector(".popup__list").innerHTML=""},F=document.querySelector(".places__list"),g=document.querySelector(".popup_type_edit"),h=g.querySelector(".popup__form"),O=h.querySelector(".popup__input_type_name"),V=h.querySelector(".popup__input_type_description"),C=document.querySelector(".popup_type_new-card"),f=C.querySelector(".popup__form"),fe=f.querySelector(".popup__input_type_card-name"),_e=f.querySelector(".popup__input_type_url"),S=document.querySelector(".popup_type_image"),x=S.querySelector(".popup__image"),me=S.querySelector(".popup__caption"),he=document.querySelector(".profile__edit-button"),ye=document.querySelector(".profile__add-button"),b=document.querySelector(".profile__title"),q=document.querySelector(".profile__description"),E=document.querySelector(".profile__image"),k=document.querySelector(".popup_type_edit-avatar"),_=k.querySelector(".popup__form"),ve=_.querySelector(".popup__input"),W=document.querySelector(".popup_type_info"),ge=document.querySelector(".header__logo"),I=W.querySelector(".popup__content"),z=({name:e,link:t})=>{x.src=t,x.alt=e,me.textContent=e,m(S)},Ce=e=>{e.preventDefault();const t=h.querySelector(".button");t.textContent="Сохранение...",D({name:O.value,about:V.value}).then(o=>{b.textContent=o.name,q.textContent=o.about,d(g)}).catch(o=>{console.log(o)}).finally(()=>t.textContent="Сохранить")},Se=e=>{e.preventDefault();const t=_.querySelector(".button");t.textContent="Сохранение...",H({avatar:ve.value}).then(o=>{E.style.backgroundImage=`url(${o.avatar})`,d(k)}).catch(o=>{console.log(o)}).finally(()=>t.textContent="Сохранить")},be=e=>{e.preventDefault();const t=f.querySelector(".button");t.textContent="Создание...",J({name:fe.value,link:_e.value}).then(o=>{F.prepend(U(o,o.owner._id,{onPreviewPicture:z,onLikeIcon:M,onDeleteCard:A})),d(C)}).catch(o=>{console.log(o)}).finally(()=>t.textContent="Создать")};h.addEventListener("submit",Ce);f.addEventListener("submit",be);_.addEventListener("submit",Se);he.addEventListener("click",()=>{O.value=b.textContent,V.value=q.textContent,m(g),v(h,y)});E.addEventListener("click",()=>{_.reset(),m(k),v(_,y)});ye.addEventListener("click",()=>{f.reset(),m(C),v(f,y)});ge.addEventListener("click",()=>{de(I),Promise.all([K(),B()]).then(([e,t])=>{const o=ce(t);pe(I,"Статистика карточек",[["Всего пользователей",se(e,t).length],["Всего лайков",le(t)],["Максимально лайков от одного",o.score],["Чемпион лайков",o.username]],"Популярные карточки:",ie(t))}).catch(e=>{console.log(e)}),m(W)});const qe=document.querySelectorAll(".popup");qe.forEach(e=>{Q(e)});const Ee=e=>{const t=e.value;return t.length<2||t.length>40||!/^[a-zA-Zа-яА-ЯёЁ\s\-]+$/.test(t)?1:e.validity.valid?0:2},ke=e=>{const t=e.value;return t.length<2||t.length>200?1:e.validity.valid?0:2},Le=e=>{const t=e.value;return t.length<2||t.length>40||!/^[a-zA-Zа-яА-ЯёЁ\s\-]+$/.test(t)?1:e.validity.valid?0:2},w=e=>{const t=e.value;return/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w%\.-]*)*\/?(\?[&\w=]*)?(#[\w-]*)?$/i.test(t)?e.validity.valid?0:2:1},xe=e=>`#${e.id}-error`,y={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible",errorMessage:"data-error-message",getErrorId:xe,formsCount:3,validators:[[Ee,ke],[Le,w],[w]]};re(y);Promise.all([B(),j()]).then(([e,t])=>{console.log(e),e.forEach(o=>{let r=U(o,t._id,{onPreviewPicture:z,onLikeIcon:M,onDeleteCard:o.owner._id===t._id?A:null});o.owner._id!==t._id&&r.querySelector(".card__control-button_type_delete").remove(),F.append(r)}),b.textContent=t.name,q.textContent=t.about,E.style.backgroundImage=`url(${t.avatar})`}).catch(e=>{console.log(e)});
